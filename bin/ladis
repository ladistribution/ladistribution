#!/usr/bin/php
<?php

error_reporting( E_ALL | E_NOTICE | E_STRICT );

define('LD_CLI', true);

define('LD_DIR', realpath( dirname(__FILE__) . '/..' ) );

define('LD_LIB_DIR', LD_DIR . '/lib');

set_include_path( LD_LIB_DIR . PATH_SEPARATOR . get_include_path() );

// In case ZF is not available
if (!file_exists(LD_LIB_DIR . '/Zend/Loader/Autoloader.php')) {
    define('LD_CLI_INSTALL', true);
    include(LD_DIR . '/installer.php');
}

$loader = LD_LIB_DIR . "/Ld/Loader.php";
if (file_exists($loader)) { require_once $loader; } else { require_once "Ld/Loader.php"; }

Ld_Loader::registerAutoload();

try {

    if (isset($argv[1]) && $argv[1] == 'package') {
        $cli = new Ld_Cli_Package();
    } elseif (isset($argv[1]) && $argv[1] == 'site') {
        $cli = new Ld_Cli_Site();
    } else {
        $cli = new Ld_Cli();
    }

    $cli->dispatch();

} catch (Exception $e) {
    fwrite(STDOUT, 'Error: ' . $e->getMessage() . PHP_EOL);
    if (defined('LD_DEBUG') && constant('LD_DEBUG')) {
        fwrite(STDOUT, $e->getTraceAsString() . PHP_EOL);
    }
}
